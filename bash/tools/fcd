#!/bin/bash


show_all=false
recursive=false
interactive=false
dir="."

get_preview(){
    local name="$1"
    if [[ "$name" == "EXIT (quit)" ]]; then
        echo "This will exit the program"
    elif [[ -d "$name" ]]; then
        echo "$(eza -lah --color=always $name)"
    else
        echo  "$(batcat --color=always $name --style=plain --paging=never)"
    fi

}

export -f get_preview

while (( "$#" )); do
    case "$1" in
        -a) show_all=true ;;
        -r) recursive=true ;;
        -i) interactive=true ;;
        -*) echo "Unknown option: $1"; return ;;
        *) dir="$1" ;;
    esac
    shift
done

fd_opts="--type d --type f --exclude .git --color=always"
[ "$show_all" = "true" ] && fd_opts="$fd_opts --hidden"
[ "$recursive" = "false" ] && fd_opts="$fd_opts --maxdepth 1"

if [ "$interactive" = "false" ]; then
    target=$(fdfind $fd_opts . $dir | fzf \
            --height 50% \
            --preview-window 'right:70%,nowrap' \
            --ansi \
            --reverse \
        --preview 'get_preview {}') || exit

    if [ -z "$target" ]; then
        return
    elif [ -d "$target" ]; then
        cd "$target" || return
    else
        cd "$(dirname "$target")" && nano "$target" || exit
    fi

else


    while true; do
        target=$(
            {
                echo "EXIT (quit)";       # quit option
                echo "..";        # go up one dir
                fdfind $fd_opts . "$dir";
            } | fzf --height 50% \
                --reverse \
                --ansi \
                --preview-window 'right:70%,nowrap' \
                --preview 'get_preview {}'
        ) || break  # if fzf is canceled

        # handle special selections
        if [[ "$?" == "130" ]]; then
            exit 1
            break
        elif [[ "$target" == "EXIT (quit)" ]]; then
            break
        elif [[ "$target" == ".." ]]; then
            cd .. || break
            dir="."  # reset dir to current
        else
            if [[ -d "$target" ]]; then
                cd "$target" || break
                dir="."  # reset dir to current
            else
                cd "$(dirname "$target")" || break
                dir="."  # reset dir to current
            fi
        fi
    done

fi


