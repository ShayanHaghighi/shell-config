#!/bin/bash

source "$XDG_CONFIG_HOME/cheat/lib/parsing.sh"
source "$XDG_CONFIG_HOME/cheat/lib/read_input.sh"

NOTE_DIR="$XDG_CONFIG_HOME/cheat/cheatsheets/community/"

fuzzy_find="false"


get_language(){
    local note_path="$1"
    eval $(get_parts "$note_path")
    local lang=$(batcat --list-languages | awk -F ':' '{print $1}' | grep -ix "$base_topic")
    echo "${lang:-'bash'}"
}
export -f get_language

edit_mode="false"
edit_path=""

while getopts "fe:" opt; do
    case $opt in
        f)
            fuzzy_find="true"
            ;;
        e)
            edit_mode="true"
            edit_path="$OPTARG"
            ;;
        \?)
            echo "Invalid option"
            exit 1
            ;;
    esac
done

shift $((OPTIND - 1))

if [[ "$edit_mode" == "true" ]]; then
    target_file="/home/shayan/.config/cheat/cheatsheets/personal/$edit_path"

    target_dir=$(dirname "$target_file")
    mkdir -p "$target_dir"

    ${EDITOR:-nvim} "$target_file"
    exit 0
fi

tmp=$(mktemp)
trap 'rm -f "$tmp"' EXIT

if [[ "$fuzzy_find" == "true" ]]; then
    note_path=$(fdfind . "$XDG_CONFIG_HOME/cheat/cheatsheets/" | \
        sed -E 's#^.*(personal|community)/?(.*)$#\2#' | \
        grep -v 'README.md' | \
        grep '/' | \
        fzf --preview 'base_name=$(echo {} | cut -d "/" -f 1); \
        lang_name=$(batcat --list-languages | awk -F ":" '\''{print $1}'\'' | grep -ix $base_name); \
        cheat {} | batcat --color=always -l ${lang_name:-"bash"}')

    if [[ ! $note_path ]]; then
        exit 0
    fi
    eval $(get_parts $note_path)
else
    query=$(read_input $1)
    eval $(get_parts $query)
    note_path="$base_topic/$sub_topic"
fi
if ! cheat "$note_path" > "$tmp" 2> /dev/null; then
    #TODO write to tmp dir?
    if ! curl -s "cht.sh/$query" -o "$tmp"; then
        echo "failed to fetch data"
        exit 1
    fi
    # clean input
    sed -i 's/\x1b\[[0-9;]*m//g' "$tmp"

    is_ok=$(is_response_ok "$tmp")
    case "$is_ok" in
        "invalid") echo "not a valid cheat sheet"; exit 0
            ;;
        "unknown") cat "$tmp"; exit 0
            ;;
    esac

        dir="$NOTE_DIR/$base_topic"  
        abs_file_path="$dir/$sub_topic"
        mkdir -p "$dir"  
        if [[ ! -f $abs_file_path ]]; then
            cp "$tmp" "$abs_file_path"
            echo "saved to dir: $note_path"
        fi
fi

if [[ $(batcat --list-languages | awk -F ':' '{print $1}' | grep -ix "$base_topic") ]]; then
    batcat -l "$base_topic" --paging always --file-name "$note_path" "$tmp"
else
    batcat -l "bash" --paging always --file-name "$note_path" "$tmp"
fi


